<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.19.2 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>[열혈TCP/IP] 10 멀티프로세스 기반의 서버 구현 - NiklasJang’s Blog</title>
<meta name="description" content="반갑습니다. niklas jang입니다. ">


  <meta name="author" content="Niklas Jang">


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="NiklasJang's Blog">
<meta property="og:title" content="[열혈TCP/IP] 10 멀티프로세스 기반의 서버 구현">
<meta property="og:url" content="http://localhost:4000/ardenttcpip/chapter-10/">


  <meta property="og:description" content="반갑습니다. niklas jang입니다. ">







  <meta property="article:published_time" content="2020-01-13T00:00:00+09:00">






<link rel="canonical" href="http://localhost:4000/ardenttcpip/chapter-10/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": null,
      "url": "http://localhost:4000/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="NiklasJang's Blog Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          NiklasJang's Blog
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/posts/">Posts</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/">Categories</a>
            </li><li class="masthead__menu-item">
              <a href="/tags/">Tags</a>
            </li><li class="masthead__menu-item">
              <a href="/about/">About</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/assets/images/profile0.jpg" alt="Niklas Jang" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Niklas Jang</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>뜻이 있는 곳에 길이 있다.</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Republic of Korea</span>
        </li>
      

      
        
          
            <li><a href="mailto:niklajang@gmail.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span></a></li>
          
        
          
            <li><a href="https://github.com/niklasjang" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="[열혈TCP/IP] 10 멀티프로세스 기반의 서버 구현">
    <meta itemprop="description" content="">
    <meta itemprop="datePublished" content="2020-01-13T00:00:00+09:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">[열혈TCP/IP] 10 멀티프로세스 기반의 서버 구현
</h1>
          
            <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  5 minute read

</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right sticky">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-list"></i> Table of contents</h4></header>
              <ul class="toc__menu">
  <li><a href="#10-멀티프로세스-기반의-서버-구현">10 멀티프로세스 기반의 서버 구현</a></li>
  <li><a href="#10-3-시그널-핸들링">10-3 시그널 핸들링</a>
    <ul>
      <li><a href="#10-4-멀티테스킹-기반의-다중접속-서버">10-4 멀티테스킹 기반의 다중접속 서버</a></li>
      <li><a href="#10-5-tcp의-입출력-투린rountine-분할">10-5 TCP의 입출력 투린(Rountine) 분할</a></li>
    </ul>
  </li>
</ul>

            </nav>
          </aside>
        
        <h1 id="10-멀티프로세스-기반의-서버-구현">10 멀티프로세스 기반의 서버 구현</h1>

<ul>
  <li>프로세스 : 실행 중인 프로그램</li>
  <li>멀티프로세스 기반 서버 : 다수의 프로세스를 생성하는 방식으로 서비스 제공
    <ul>
      <li>쿼드 코어 : 4개의 연산장치가 존재하는 CPU</li>
      <li>코어의 수만큼 프로세스를 동시에 실행시킬 수 있다.</li>
      <li>코어의 수를 넘어서는 프로세스가 생성되면, 프로세스 별로 코어에 할당되는 시간이 나뉜다.</li>
    </ul>
  </li>
  <li>멀티플렉싱 기반 서버 : 입출력 대상을 묶어서 관리하는 방식으로 서비스 제공</li>
  <li>멀티쓰레딩 기반 서버 : 클라이언트의 수만큼 쓰레드를 생성하는 방식으로 서비스 세공</li>
</ul>

<p>fork 함수 호출을 통한 프로세스의 생성</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;unistd.h&gt;
</span>
<span class="n">pid_t</span> <span class="nf">fork</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</code></pre></div></div>

<p>fork 함수는 호출한 프로세스의 복사본을 생성한다. 즉, 이미 실행 중인 프로세스를 복사하는 것이다. 이후 두 프로세스 모두 fork 함수의 호출 이후 문장을 실행하게 된다. 그런데 완전히 동일한 프로세스로 메모리 영역까지 동일하게 복사하기 때문에 이후의 프로그램 흐름은 fork 함수의 반환 값을 기준으로 나뉘도록 프로그래밍 해야한다. 즉, fork 함수의 다음 특징을 이용해서 프로그램의 흐름을 구분해야 한다.</p>

<ul>
  <li>부모 프로세스 : fork 함수의 반환값은 자식 프로세스의 PID</li>
  <li>자식 프로세스 : fork 함수의 반환값은 0</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//부모 프로세스</span>
<span class="kt">int</span> <span class="n">gval</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="kt">int</span> <span class="nf">main</span> <span class="p">(</span><span class="kt">void</span><span class="p">){</span>
    <span class="kt">int</span> <span class="n">lval</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
    <span class="n">lval</span> <span class="o">+=</span> <span class="mi">5</span><span class="p">;</span>
    <span class="n">gval</span><span class="o">++</span><span class="p">;</span>
    <span class="n">pid_t</span> <span class="n">pid</span><span class="o">=</span><span class="n">fork</span><span class="p">();</span>
    <span class="k">if</span><span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
        <span class="n">gval</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="n">lval</span><span class="o">++</span><span class="p">;</span> <span class="c1">//실행됨</span>
        <span class="p">...</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//자식 프로세스</span>
<span class="c1">//gval은 11로 복사</span>
<span class="kt">int</span> <span class="nf">main</span> <span class="p">(</span><span class="kt">void</span><span class="p">){</span>
    <span class="c1">//lval은 25로 복사</span>
    <span class="p">.</span> <span class="p">.</span> <span class="p">.</span> <span class="p">.</span>

    <span class="n">pid_t</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">();</span>
    <span class="k">if</span><span class="p">(</span><span class="n">pid</span><span class="o">==</span><span class="mi">0</span><span class="p">){</span>
        <span class="n">gval</span><span class="o">++</span><span class="p">;</span> <span class="c1">//실행됨</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="n">lval</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>좀비 프로세스의 생성이유</p>

<p>좀비 프로세스의 생성 이유를 먼저 살펴보자. fork() 함수의 호출로 생성된 자식 프로세스가 종료되는 상황 두 가지를 예로 들면 다음과 같다.</p>

<ol>
  <li>인자로 전달하면서 exit를 호출하는 경우</li>
  <li>main 함수에서 return 문을 실행하면서 값을 반환하는 경우</li>
</ol>

<p>exit()과 main의 return에 의해서 반환되는 값 모두 운영체제로 전달된다. 그리고 운영체제는 이 값이 자식 프로세스를 생성한 부모 프로세스에게 전달될 때까지 자식 프로세스를 소멸시키지앟는다. 이 상황의 프로세스를 좀비 프로세스라고 한다. 바꿔말하면,</p>

<blockquote>
  <p>해당 자식 프로세스를 생성한 부모 프로세스에게 exit 함수의 인자값이나 return 문의 반환값이 전달되어여 한다.</p>
</blockquote>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//좀비 프로세스 만들기 예제</span>
<span class="cp">#include &lt;stdio.h&gt;
#include &lt;unistd.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="n">pid_t</span> <span class="n">pid</span><span class="o">=</span><span class="n">fork</span><span class="p">();</span>
	
	<span class="k">if</span><span class="p">(</span><span class="n">pid</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>     <span class="c1">// if Child Process</span>
	<span class="p">{</span>
		<span class="n">puts</span><span class="p">(</span><span class="s">"Hi I'am a child process"</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"Child Process ID: %d </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
		<span class="n">sleep</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>     <span class="c1">// Sleep 30 sec.</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">pid</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
		<span class="n">puts</span><span class="p">(</span><span class="s">"End child process"</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">puts</span><span class="p">(</span><span class="s">"End parent process"</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>좀비 프로세스의 상태는 콘솔에서 <code class="language-plaintext highlighter-rouge">ps au</code>를 치고 STATUS가 z+인 것을 찾으면 된다.</p>

<p>좀비 프로세스의 소멸 1: wait 함수를 사용</p>

<p>wait() 함수가 호출되었을 때 이미 종료된 자식 프로세스가 있다면, 자식 프로세스가 종료되면서 전달한 값이 매개변수로 전달된 주소의 변수에 저장된다. 그런데 이 변수에 저장되는 값에는 자식프로세스가 종료되면서 전달한 값 이외에도 다른 정보가 함께 포함되어 있으니, 다음 매크로 함수를 통해서 값의 분리 과정을 거쳐야 한다.</p>

<ul>
  <li>WIFEXITED : 자식 프로세스가 정상 종료한 경우 true를 반환한다.</li>
  <li>WEXITSTATUS : 자식 프로세스의 전달 값을 반환한다.</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">WIEXITED</span><span class="p">(</span><span class="n">status</span><span class="p">)){</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"Nornal itermination! "</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Child pass num : %d "</span><span class="p">,</span> <span class="n">WEXITSTATUS</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div>

<p>좀비 프로세스의 소멸 2: waitpid 함수를 사용</p>

<p>waitpit() 함수는 종료를 확인하고자하는 pid를 전달하면 wait()함수와 마찬가지로 해당 프로세스가종료될 때까지 기다린다. -1을 전달하면 임의의 자식 프로세스가 종료되기를 기다린다. 3번째 param에 WHOHANG을 전달하면 종료된 자식 프로세스가 존재하지 않아도 블로킹 상태에 있지않고 0을 반환하면서 함수를 빠져나온다.</p>

<p>책 232페이지</p>

<h1 id="10-3-시그널-핸들링">10-3 시그널 핸들링</h1>

<p>시그널 핸들링은 언제 자식 프로세스가 종료될지 몰라서 사용한다. 언제까지 계속 waitpid를 호출할 수 없기 때문이다. 그래서 시그널을 사용한다.</p>

<p>프로세스 : 운영체제야, 내가 생성한 자식 프로세스가 종료되면 zombie_handler라는 이름의 함수를 호출해줘<br />
운영체제 : 알겠어, 그 상황에서 실행해야 할 문장들을 그 함수에 잘 묶어둬</p>

<ul>
  <li>SIGALRM : alarm 함수 호출을 통해서 등록된 시간이 된 상황</li>
  <li>SIGINT : ctrl + c가 입력된 상황</li>
  <li>SIGCHLD : 자식 프로세스가 종료된 상황</li>
</ul>

<p>위 신호들을 signal(SIGCHLD, mychild)와 같이 실행하면 된다.  책 236페이지</p>

<blockquote>
  <p>sigaction() 함수는 signal 함수의 문제점(유닉스 계열의 운영체제에서는 차이점이 있을 수 있음)을 보완하고 대체할 수 있는 함수이다.</p>
</blockquote>

<p>책 239페이지</p>

<h2 id="10-4-멀티테스킹-기반의-다중접속-서버">10-4 멀티테스킹 기반의 다중접속 서버</h2>

<ul>
  <li>서버의 부모 프로세스는 클라가 연결요청을 하면 자식 프로세스를 만들고, 자식 프로세스와 클라를 연결한다.</li>
  <li>에코 클라이언트는 서버의 부모 프로세스에게 연결 요청을 하고, 서버의 자식 프로세스랑 연결이 된다.</li>
</ul>

<p>위 기능을 구현하는 과정은 아래와 같다.</p>

<ol>
  <li>1단계 : 에코 서버(부모 프로세스)는 accept 함수호출을 통해서 연결요청을 수락한다.</li>
  <li>2단계 : 이때 얻게 되는 소켓의 fd를 자식 프로세스를 생성해서 넘겨준다.</li>
  <li>3단계 : 자식 프로세스는 전달받은 fd를 바탕으로 서비스를 제공한다.</li>
</ol>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//다중접속 에코 프로그램의 클라이언트</span>
<span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;unistd.h&gt;
#include &lt;arpa/inet.h&gt;
#include &lt;sys/socket.h&gt;
</span>
<span class="cp">#define BUF_SIZE 30
</span><span class="kt">void</span> <span class="nf">error_handling</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">message</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">read_routine</span><span class="p">(</span><span class="kt">int</span> <span class="n">sock</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">write_routine</span><span class="p">(</span><span class="kt">int</span> <span class="n">sock</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">sock</span><span class="p">;</span>
	<span class="n">pid_t</span> <span class="n">pid</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">BUF_SIZE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">serv_adr</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">argc</span><span class="o">!=</span><span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"Usage : %s &lt;IP&gt; &lt;port&gt;</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	
	<span class="n">sock</span><span class="o">=</span><span class="n">socket</span><span class="p">(</span><span class="n">PF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>  
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serv_adr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">serv_adr</span><span class="p">));</span>
	<span class="n">serv_adr</span><span class="p">.</span><span class="n">sin_family</span><span class="o">=</span><span class="n">AF_INET</span><span class="p">;</span>
	<span class="n">serv_adr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="o">=</span><span class="n">inet_addr</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">serv_adr</span><span class="p">.</span><span class="n">sin_port</span><span class="o">=</span><span class="n">htons</span><span class="p">(</span><span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]));</span>
	
	<span class="k">if</span><span class="p">(</span><span class="n">connect</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">serv_adr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">serv_adr</span><span class="p">))</span><span class="o">==-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">error_handling</span><span class="p">(</span><span class="s">"connect() error!"</span><span class="p">);</span>

	<span class="n">pid</span><span class="o">=</span><span class="n">fork</span><span class="p">();</span>
	<span class="k">if</span><span class="p">(</span><span class="n">pid</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
		<span class="n">write_routine</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="k">else</span> 
		<span class="n">read_routine</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

	<span class="n">close</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">read_routine</span><span class="p">(</span><span class="kt">int</span> <span class="n">sock</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">str_len</span><span class="o">=</span><span class="n">read</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">BUF_SIZE</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">str_len</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">buf</span><span class="p">[</span><span class="n">str_len</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"Message from server: %s"</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">write_routine</span><span class="p">(</span><span class="kt">int</span> <span class="n">sock</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">fgets</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">BUF_SIZE</span><span class="p">,</span> <span class="n">stdin</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="s">"q</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="s">"Q</span><span class="se">\n</span><span class="s">"</span><span class="p">))</span>
		<span class="p">{</span>	
			<span class="n">shutdown</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">SHUT_WR</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">write</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">error_handling</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">message</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fputs</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">stderr</span><span class="p">);</span>
	<span class="n">fputc</span><span class="p">(</span><span class="sc">'\n'</span><span class="p">,</span> <span class="n">stderr</span><span class="p">);</span>
	<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

</code></pre></div></div>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//멀티 태스킹 에코 프로그램의 서버</span>
<span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;unistd.h&gt;
#include &lt;signal.h&gt;
#include &lt;sys/wait.h&gt;
#include &lt;arpa/inet.h&gt;
#include &lt;sys/socket.h&gt;
</span>
<span class="cp">#define BUF_SIZE 30
</span><span class="kt">void</span> <span class="nf">error_handling</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">message</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">read_childproc</span><span class="p">(</span><span class="kt">int</span> <span class="n">sig</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">serv_sock</span><span class="p">,</span> <span class="n">clnt_sock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">serv_adr</span><span class="p">,</span> <span class="n">clnt_adr</span><span class="p">;</span>
	
	<span class="n">pid_t</span> <span class="n">pid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sigaction</span> <span class="n">act</span><span class="p">;</span>
	<span class="n">socklen_t</span> <span class="n">adr_sz</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">str_len</span><span class="p">,</span> <span class="n">state</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">BUF_SIZE</span><span class="p">];</span>
	<span class="k">if</span><span class="p">(</span><span class="n">argc</span><span class="o">!=</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"Usage : %s &lt;port&gt;</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">act</span><span class="p">.</span><span class="n">sa_handler</span><span class="o">=</span><span class="n">read_childproc</span><span class="p">;</span>
	<span class="n">sigemptyset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">act</span><span class="p">.</span><span class="n">sa_mask</span><span class="p">);</span>
	<span class="n">act</span><span class="p">.</span><span class="n">sa_flags</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">state</span><span class="o">=</span><span class="n">sigaction</span><span class="p">(</span><span class="n">SIGCHLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">act</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">serv_sock</span><span class="o">=</span><span class="n">socket</span><span class="p">(</span><span class="n">PF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serv_adr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">serv_adr</span><span class="p">));</span>
	<span class="n">serv_adr</span><span class="p">.</span><span class="n">sin_family</span><span class="o">=</span><span class="n">AF_INET</span><span class="p">;</span>
	<span class="n">serv_adr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="o">=</span><span class="n">htonl</span><span class="p">(</span><span class="n">INADDR_ANY</span><span class="p">);</span>
	<span class="n">serv_adr</span><span class="p">.</span><span class="n">sin_port</span><span class="o">=</span><span class="n">htons</span><span class="p">(</span><span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
	
	<span class="k">if</span><span class="p">(</span><span class="n">bind</span><span class="p">(</span><span class="n">serv_sock</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span><span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">serv_adr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">serv_adr</span><span class="p">))</span><span class="o">==-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">error_handling</span><span class="p">(</span><span class="s">"bind() error"</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">listen</span><span class="p">(</span><span class="n">serv_sock</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span><span class="o">==-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">error_handling</span><span class="p">(</span><span class="s">"listen() error"</span><span class="p">);</span>
	
	<span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">adr_sz</span><span class="o">=</span><span class="k">sizeof</span><span class="p">(</span><span class="n">clnt_adr</span><span class="p">);</span>
		<span class="n">clnt_sock</span><span class="o">=</span><span class="n">accept</span><span class="p">(</span><span class="n">serv_sock</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">clnt_adr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adr_sz</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">clnt_sock</span><span class="o">==-</span><span class="mi">1</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">puts</span><span class="p">(</span><span class="s">"new client connected..."</span><span class="p">);</span>
		<span class="n">pid</span><span class="o">=</span><span class="n">fork</span><span class="p">();</span>
		<span class="k">if</span><span class="p">(</span><span class="n">pid</span><span class="o">==-</span><span class="mi">1</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">close</span><span class="p">(</span><span class="n">clnt_sock</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span><span class="p">(</span><span class="n">pid</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">close</span><span class="p">(</span><span class="n">serv_sock</span><span class="p">);</span>
			<span class="k">while</span><span class="p">((</span><span class="n">str_len</span><span class="o">=</span><span class="n">read</span><span class="p">(</span><span class="n">clnt_sock</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">BUF_SIZE</span><span class="p">))</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span>
				<span class="n">write</span><span class="p">(</span><span class="n">clnt_sock</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">str_len</span><span class="p">);</span>
			
			<span class="n">close</span><span class="p">(</span><span class="n">clnt_sock</span><span class="p">);</span>
			<span class="n">puts</span><span class="p">(</span><span class="s">"client disconnected..."</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span>
			<span class="n">close</span><span class="p">(</span><span class="n">clnt_sock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">close</span><span class="p">(</span><span class="n">serv_sock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">read_childproc</span><span class="p">(</span><span class="kt">int</span> <span class="n">sig</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pid_t</span> <span class="n">pid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">pid</span><span class="o">=</span><span class="n">waitpid</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="n">WNOHANG</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"removed proc id: %d </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">error_handling</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">message</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fputs</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">stderr</span><span class="p">);</span>
	<span class="n">fputc</span><span class="p">(</span><span class="sc">'\n'</span><span class="p">,</span> <span class="n">stderr</span><span class="p">);</span>
	<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>서버 코드에서 accept() 이후 fork를 하기 때문에 부모와 자식 프로세스 모두 accept를 통해서 만들어진 소켓의 fd를 갖는다. fork 함수가 호출되면서 부모 프로세스의 모든 것이 복사되니 소켓도 함꼐 복사될 것 같지만, 소켓은 프로세스의 소유가 아니다. 엄밀히 말해서 운영체제의 소유이기 때문에 프로세스의 소유인 소켓의 fd만 복사된다. 소켓의 소유 주체가 운영체제인 점을 생각하지 않아도 소켓이 복사도니다면 동일한 port에 할당된 소켓이 둘 이상된다는 문제점이 있기 때문에 소켓 자체가 복사되는 것이 아닌 것을 생각할 수 있다.</p>

<p>하나의 소켓에 두 개의 파일 디스크립터가 존재하는 경우, 두 개의 파일디스크립터가 모두 종료(소멸)되어야 소켓이 소멸된다. 다라서 자식 프로세스가 클라와 연결되엉 있는 소켓을 소멸하려고 해도 소멸되지 않고 계속 남아있게 된다. (이는 서버 소켓도 마찬가지이다.) 그래서 fork 함수호출 후에는 서로 상관이 없는 소켓의 파일 디스크립터를 닫아줘야 한다.</p>

<p>위 코드에서 serv_sock은  클라의 연결요청을 받아들이는소켓이고, clnt_sock은 accept이후 반환된 클라와 연결될 때 사용되는 소켓의 fd이다. 그래서 자식 프로세스는 서버 소켓의 fd가 필요없어서 close(serv_sock)을 실행하고 다음 본인의 로직을 실행하고, else 부분에서는 close(clnt_sock)으로 부모 프로세스에서 자식 프로세스에서만 쓰이는 클라이언트 소켓 fd를 close 한다.</p>

<h2 id="10-5-tcp의-입출력-투린rountine-분할">10-5 TCP의 입출력 투린(Rountine) 분할</h2>

<p>클라이언트에서 read()와 write()를 동기방식으로 진행하는데 이를 클라이언트 쪽에서 fork를 통해서 클라이언트의 부모 프로세스는 read()를 하고, 클라이언트의 자식 프로세스는 write()를 하는 방식으로 코드를 짤 수 있다. 가능한 것이지 이 기능을 에코 프로그램에서 유의미한 기능을 하는 것은 아니다.</p>

<p>책 250 페이지</p>


        
      </section>

      <footer class="page__meta">
        
        


  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#ardenttcpip" class="page__taxonomy-item" rel="tag">ArdentTCPIP</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2020-01-13T00:00:00+09:00">January 13, 2020</time></p>
        
      </footer>

      <section class="page__share">
  

  <a href="https://twitter.com/intent/tweet?text=%5B%EC%97%B4%ED%98%88TCP%2FIP%5D+10+%EB%A9%80%ED%8B%B0%ED%94%84%EB%A1%9C%EC%84%B8%EC%8A%A4+%EA%B8%B0%EB%B0%98%EC%9D%98+%EC%84%9C%EB%B2%84+%EA%B5%AC%ED%98%84%20http%3A%2F%2Flocalhost%3A4000%2Fardenttcpip%2Fchapter-10%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Flocalhost%3A4000%2Fardenttcpip%2Fchapter-10%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Flocalhost%3A4000%2Fardenttcpip%2Fchapter-10%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/ardenttcpip/chapter-5/" class="pagination--pager" title="[열혈TCP/IP] 05 TCP 기반 서버 / 클라이언트 2
">Previous</a>
    
    
      <a href="/ardenttcpip/chapter-11/" class="pagination--pager" title="[열혈TCP/IP] 11 프로세스간 통신 Inter Process communication
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You May Also Enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/backend/tobby-spring-0/" rel="permalink">[Spring]
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  1 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">토비의 스프링 3.1 Vol. 1: 스프링의 이해와 원리
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/backend/roadmap-1-3/" rel="permalink">[RoadMap] Chap 1-3. Basic Frontend Knowledge - JavaScript
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  4 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">github.com/kamranahmedse/developer-roadmap
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/backend/roadmap-1-2/" rel="permalink">[RoadMap] Chap 1-2. Basic Frontend Knowledge - CSS
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  2 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">github.com/kamranahmedse/developer-roadmap
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/backend/roadmap-1-1/" rel="permalink">[RoadMap] Chap 1-1. Basic Frontend Knowledge - HTML
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  3 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">github.com/kamranahmedse/developer-roadmap
</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    
      
        
          <li><a href="https://github.com/niklasjang" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2020 NiklasJang's Blog. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>







  </body>
</html>
